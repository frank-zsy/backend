{% extends "horizontal_base.html" %}
{% load static %}

{% block extra_css %}
<style>
    [x-cloak] {
        display: none !important;
    }

    .result-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        height: 100%;
    }

    .result-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 30px rgba(102, 126, 234, 0.15);
    }

    .filter-label {
        font-weight: 600;
        font-size: 0.95rem;
    }

    .bio-text {
        min-height: 60px;
    }
</style>
{% endblock extra_css %}

{% block content %}
<div class="d-flex flex-column flex-lg-row gap-3 align-items-lg-center justify-content-between mb-4">
    <div>
        <h2 class="mb-1">搜索 “{{ query }}” 的结果</h2>
        <p class="text-muted mb-0">
            共找到 {{ results_count }} 位用户{% if results|length == max_results %}（已显示前 {{ max_results }} 条）{% endif %}
        </p>
    </div>
    <a class="btn btn-outline-primary" href="{% url 'homepage:index' %}">返回首页</a>
</div>

<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3 align-items-end">
            <input type="hidden" name="q" value="{{ query }}" />

            <div class="col-md-3 col-sm-6">
                <label class="filter-label" for="filter-location">所在地</label>
                <select class="form-select" id="filter-location" name="location">
                    <option value="">全部</option>
                    {% for option in available_locations %}
                    <option value="{{ option }}" {% if filters.location == option %}selected{% endif %}>{{ option }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-3 col-sm-6">
                <label class="filter-label" for="filter-company">公司 / 组织</label>
                <select class="form-select" id="filter-company" name="company">
                    <option value="">全部</option>
                    {% for option in available_companies %}
                    <option value="{{ option }}" {% if filters.company == option %}selected{% endif %}>{{ option }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-2 col-sm-6">
                <label class="filter-label" for="filter-min-points">最低积分</label>
                <input
                    type="number"
                    class="form-control"
                    id="filter-min-points"
                    name="min_points"
                    min="0"
                    value="{{ filters.min_points }}"
                    placeholder="例如 100"
                />
            </div>

            <div class="col-md-2 col-sm-6">
                <label class="filter-label" for="filter-sort">排序</label>
                <select class="form-select" id="filter-sort" name="sort">
                    <option value="relevance" {% if filters.sort == "relevance" %}selected{% endif %}>按活跃度</option>
                    <option value="points_desc" {% if filters.sort == "points_desc" %}selected{% endif %}>积分从高到低</option>
                    <option value="points_asc" {% if filters.sort == "points_asc" %}selected{% endif %}>积分从低到高</option>
                    <option value="username" {% if filters.sort == "username" %}selected{% endif %}>按用户名排序</option>
                </select>
            </div>

            <div class="col-md-2 col-sm-12 d-grid">
                <button type="submit" class="btn btn-primary">应用筛选</button>
            </div>
        </form>
    </div>
</div>

{% if results|length == 0 %}
<div class="alert alert-info mb-0">
    暂无匹配的用户，试试调整关键词或筛选条件。
</div>
{% else %}
{{ results|json_script:"search-results-data" }}
<div x-data="searchResultsComponent({{ page_size }})" x-cloak>
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-3">
        <div class="text-muted">
            第 <span x-text="currentPage"></span> / <span x-text="totalPages"></span> 页，共 <span x-text="results.length"></span> 条记录
        </div>
        <div class="d-flex align-items-center gap-2">
            <span class="text-muted">每页显示</span>
            <div class="btn-group" role="group" aria-label="page size">
                <template x-for="size in pageSizeOptions" :key="'size-' + size">
                    <button
                        type="button"
                        class="btn btn-sm"
                        :class="size === pageSize ? 'btn-primary' : 'btn-outline-primary'"
                        @click="changePageSize(size)"
                        x-text="size"
                    ></button>
                </template>
            </div>
            <span class="text-muted">条</span>
        </div>
    </div>

    <div class="row g-4">
        <template x-for="user in paginatedResults" :key="user.username">
            <div class="col-xl-4 col-md-6">
                <div class="card result-card h-100">
                    <div class="card-body d-flex flex-column">
                        <div class="d-flex align-items-center gap-3 mb-3">
                            <img
                                :src="user.avatar_url"
                                :alt="user.display_name"
                                class="rounded-circle border"
                                width="56"
                                height="56"
                            />
                            <div>
                                <h5 class="mb-0">
                                    <a
                                        :href="user.profile_url"
                                        class="text-decoration-none"
                                        x-text="user.display_name"
                                    ></a>
                                </h5>
                                <small class="text-muted" x-text="'@' + user.username"></small>
                            </div>
                        </div>
                        <p class="text-muted flex-grow-1 bio-text" x-text="user.bio || '这个用户还没有填写个人简介'"></p>
                        <div class="d-flex flex-wrap gap-3 text-muted small mb-3">
                            <span class="d-inline-flex align-items-center gap-1">
                                <i data-lucide="pin" class="icon-sm"></i>
                                <span x-text="user.location || '未填写地点'"></span>
                            </span>
                            <span class="d-inline-flex align-items-center gap-1">
                                <i data-lucide="briefcase" class="icon-sm"></i>
                                <span x-text="user.company || '自由职业者'"></span>
                            </span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mt-auto">
                            <div class="fw-semibold text-primary">
                                <span class="me-1">积分</span>
                                <span x-text="formatPoints(user.total_points)"></span>
                            </div>
                            <a :href="user.profile_url" class="btn btn-outline-primary btn-sm">查看主页</a>
                        </div>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 mt-4" x-show="totalPages > 1" x-cloak>
        <button class="btn btn-outline-secondary" :disabled="currentPage === 1" @click="goToPage(currentPage - 1)">
            上一页
        </button>
        <div class="btn-group" role="group" aria-label="pagination">
            <template x-for="page in visiblePages" :key="'page-' + page">
                <button
                    type="button"
                    class="btn"
                    :class="page === currentPage ? 'btn-primary' : 'btn-outline-primary'"
                    @click="goToPage(page)"
                    x-text="page"
                ></button>
            </template>
        </div>
        <button class="btn btn-outline-secondary" :disabled="currentPage === totalPages" @click="goToPage(currentPage + 1)">
            下一页
        </button>
    </div>
</div>
{% endif %}
{% endblock content %}

{% block extra_js %}
{{ block.super }}
<script>
    document.addEventListener("alpine:init", () => {
        Alpine.data("searchResultsComponent", (defaultPageSize) => {
            const raw = document.getElementById("search-results-data");
            const parsedResults = raw ? JSON.parse(raw.textContent) : [];

            return {
                results: parsedResults,
                pageSizeOptions: [6, 12, 24],
                pageSize: defaultPageSize,
                currentPage: 1,
                init() {
                    this.refreshIcons();
                    this.$watch("currentPage", () => this.refreshIcons());
                    this.$watch("pageSize", () => this.refreshIcons());
                },

                get totalPages() {
                    return Math.max(1, Math.ceil(this.results.length / this.pageSize));
                },

                get paginatedResults() {
                    const start = (this.currentPage - 1) * this.pageSize;
                    return this.results.slice(start, start + this.pageSize);
                },

                get visiblePages() {
                    const range = 5;
                    const pages = [];
                    let start = Math.max(1, this.currentPage - Math.floor(range / 2));
                    let end = start + range - 1;

                    if (end > this.totalPages) {
                        end = this.totalPages;
                        start = Math.max(1, end - range + 1);
                    }

                    for (let page = start; page <= end; page += 1) {
                        pages.push(page);
                    }
                    return pages;
                },

                goToPage(page) {
                    if (page < 1 || page > this.totalPages) {
                        return;
                    }
                    this.currentPage = page;
                    window.scrollTo({ top: 0, behavior: "smooth" });
                },

                changePageSize(size) {
                    if (size === this.pageSize) {
                        return;
                    }
                    this.pageSize = size;
                    this.currentPage = 1;
                },

                formatPoints(value) {
                    return new Intl.NumberFormat("zh-CN").format(value || 0);
                },

                refreshIcons() {
                    this.$nextTick(() => {
                        if (window.lucide) {
                            window.lucide.createIcons();
                        }
                    });
                },
            };
        });
    });
</script>
{% endblock extra_js %}
